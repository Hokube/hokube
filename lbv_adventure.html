<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Hokube's Adventure in LBV</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: linear-gradient(160deg, #1a4a2e 0%, #0d2a1a 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: 'Baloo 2', sans-serif;
    overflow: hidden;
    touch-action: none;
  }
  #titleBar {
    text-align: center;
    color: #fff;
    font-family: 'Baloo 2', sans-serif;
    font-size: clamp(15px, 3.5vw, 24px);
    font-weight: 800;
    padding: 6px 16px;
    letter-spacing: 1px;
    text-shadow: 3px 3px 0 #c76b00, -1px -1px 0 #c76b00;
    background: linear-gradient(90deg, #e65100, #ff8f00, #e65100);
    width: 100%;
    max-width: 800px;
    border-radius: 12px 12px 0 0;
  }
  #gameContainer {
    position: relative;
    width: 100%;
    max-width: 800px;
  }
  #gameCanvas {
    display: block;
    width: 100%;
    border-left: 4px solid #e65100;
    border-right: 4px solid #e65100;
  }
  #ui {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 16px;
    background: linear-gradient(90deg, #2e7d32, #388e3c, #2e7d32);
    border: 3px solid #e65100;
    border-top: none;
    color: #fff;
    font-family: 'Baloo 2', sans-serif;
    font-size: clamp(13px, 2.5vw, 17px);
    font-weight: 700;
    border-radius: 0 0 10px 10px;
  }
  #ui span { text-shadow: 1px 1px 2px #000; }
  #controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    width: 100%;
    max-width: 800px;
    gap: 10px;
    margin-top: 4px;
  }
  .dpad { display: flex; gap: 6px; align-items: center; }
  .btn {
    width: 58px; height: 58px;
    border-radius: 50%;
    border: 3px solid #fff;
    background: rgba(230,81,0,0.75);
    color: #fff;
    font-size: 22px;
    font-weight: 800;
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.08s, background 0.08s;
    box-shadow: 0 4px 0 rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.3);
    touch-action: manipulation;
    font-family: 'Baloo 2', sans-serif;
  }
  .btn:active, .btn.pressed {
    transform: scale(0.92) translateY(2px);
    background: rgba(255,143,0,0.9);
    box-shadow: 0 2px 0 rgba(0,0,0,0.4);
  }
  #jumpBtn {
    width: 70px; height: 70px;
    background: rgba(46,125,50,0.85);
    border-color: #a5d6a7;
    font-size: 13px;
    letter-spacing: 0.5px;
    box-shadow: 0 5px 0 rgba(0,0,0,0.4), 0 8px 15px rgba(0,0,0,0.3);
  }
  #jumpBtn:active, #jumpBtn.pressed {
    transform: scale(0.92) translateY(3px);
    box-shadow: 0 2px 0 rgba(0,0,0,0.4);
  }
  #overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.78);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center; z-index: 10;
    padding: 20px;
  }
  #overlay h1 {
    font-family: 'Baloo 2', sans-serif;
    font-size: clamp(20px, 5.5vw, 36px);
    font-weight: 800;
    color: #fff;
    text-shadow: 3px 3px 0 #c76b00, -1px -1px 0 #c76b00;
    margin-bottom: 8px;
    line-height: 1.2;
  }
  #overlay p {
    font-family: 'Baloo 2', sans-serif;
    font-size: clamp(12px, 2.8vw, 16px);
    color: #ffe0b2;
    margin: 4px 0;
    font-weight: 600;
  }
  .overlay-btn {
    margin-top: 18px;
    padding: 12px 36px;
    background: linear-gradient(135deg, #ff8f00, #e65100);
    color: #fff;
    border: none;
    font-family: 'Baloo 2', sans-serif;
    font-size: clamp(16px, 3vw, 20px);
    font-weight: 800;
    cursor: pointer;
    border-radius: 50px;
    box-shadow: 0 5px 0 #7f3100, 0 8px 20px rgba(0,0,0,0.4);
    transition: transform 0.1s, box-shadow 0.1s;
    letter-spacing: 1px;
  }
  .overlay-btn:hover { transform: translateY(-2px); box-shadow: 0 7px 0 #7f3100, 0 10px 24px rgba(0,0,0,0.4); }
  .overlay-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #7f3100; }
</style>
</head>
<body>

<div id="titleBar">üéµ HOKUBE'S ADVENTURE IN LBV üéµ</div>
<div id="gameContainer">
  <div id="overlay">
    <h1>HOKUBE'S<br>ADVENTURE IN LBV üå¥</h1>
    <p>Collecte les üíø CDs, üìº K7 et üéµ Vinyls !</p>
    <p>Saute sur les notes cass√©es pour les √©liminer !</p>
    <p style="margin-top:8px;font-size:clamp(11px,2.2vw,14px);color:#a5d6a7;">‚¨Ö ‚û° D√©placer &nbsp;¬∑&nbsp; ‚¨Ü / Espace : Sauter</p>
    <button class="overlay-btn" onclick="startGame()">‚ñ∂ &nbsp;JOUER !</button>
  </div>
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  <div id="ui">
    <span>üíø <span id="scoreDisplay">0</span> pts</span>
    <span>‚ù§Ô∏è <span id="livesDisplay">3</span></span>
    <span>üèÜ <span id="totalDisplay">0</span></span>
  </div>
</div>
<div id="controls">
  <div class="dpad">
    <button class="btn" id="leftBtn">‚óÄ</button>
    <button class="btn" id="rightBtn">‚ñ∂</button>
  </div>
  <button class="btn" id="jumpBtn">SAUT<br>‚¨Ü</button>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

// ===================== AUDIO =====================
let audioCtx=null;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function playTone(freq,type,dur,vol=0.28,f0=null,f1=null){
  if(!audioCtx)return;
  try{const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);o.type=type;
  const now=audioCtx.currentTime;
  if(f0&&f1){o.frequency.setValueAtTime(f0,now);o.frequency.exponentialRampToValueAtTime(f1,now+dur);}
  else o.frequency.setValueAtTime(freq,now);
  g.gain.setValueAtTime(vol,now);g.gain.exponentialRampToValueAtTime(0.001,now+dur);
  o.start(now);o.stop(now+dur);}catch(e){}
}
function sfxJump(){initAudio();playTone(0,'square',0.13,0.22,280,680);}
function sfxCollect(t){initAudio();
  if(t===0){playTone(880,'square',0.07,0.18);setTimeout(()=>playTone(1100,'square',0.07,0.18),55);setTimeout(()=>playTone(1320,'square',0.09,0.18),110);}
  else if(t===1){playTone(0,'square',0.14,0.18,580,880);setTimeout(()=>playTone(1200,'triangle',0.09,0.14),95);}
  else{playTone(440,'triangle',0.09,0.18);setTimeout(()=>playTone(554,'triangle',0.09,0.18),75);setTimeout(()=>playTone(659,'triangle',0.11,0.18),150);}
}
function sfxStomp(){initAudio();playTone(0,'square',0.17,0.28,380,70);setTimeout(()=>playTone(190,'sawtooth',0.07,0.1),95);}
function sfxHurt(){initAudio();playTone(220,'sawtooth',0.09,0.28);setTimeout(()=>playTone(175,'sawtooth',0.09,0.22),75);setTimeout(()=>playTone(145,'sawtooth',0.11,0.18),150);}
function sfxDie(){initAudio();[440,392,349,311,277,247,220,196,165].forEach((f,i)=>setTimeout(()=>playTone(f,'square',0.11,0.22),i*75));}
function sfxWin(){initAudio();[523,659,784,1047,784,1047,1568].forEach((f,i)=>setTimeout(()=>playTone(f,'square',0.17,0.28),i*115));}

// ===================== STATE =====================
let gameRunning=false,score=0,lives=3,camera={x:0},keys={},frameCount=0;

// ===================== PLATFORMS =====================
const platforms=[
  {x:0,y:360,w:320,h:40,type:'ground'},{x:370,y:360,w:180,h:40,type:'ground'},
  {x:600,y:360,w:260,h:40,type:'ground'},{x:910,y:360,w:280,h:40,type:'ground'},
  {x:1240,y:360,w:210,h:40,type:'ground'},{x:1500,y:360,w:380,h:40,type:'ground'},
  {x:1940,y:360,w:310,h:40,type:'ground'},{x:2300,y:360,w:520,h:40,type:'ground'},
  {x:180,y:275,w:130,h:22,type:'plat'},{x:410,y:238,w:110,h:22,type:'plat'},
  {x:640,y:198,w:125,h:22,type:'plat'},{x:840,y:258,w:110,h:22,type:'plat'},
  {x:1040,y:218,w:125,h:22,type:'plat'},{x:1290,y:278,w:110,h:22,type:'plat'},
  {x:1540,y:238,w:130,h:22,type:'plat'},{x:1740,y:195,w:110,h:22,type:'plat'},
  {x:1990,y:258,w:125,h:22,type:'plat'},{x:2190,y:215,w:110,h:22,type:'plat'},
  {x:2390,y:278,w:125,h:22,type:'plat'},{x:2590,y:235,w:110,h:22,type:'plat'},
];

// ===================== COLLECTIBLES =====================
let collectibles=[];
function generateCollectibles(){
  collectibles=[];
  [{x:80,y:322,t:0},{x:155,y:322,t:1},{x:230,y:235,t:2},
   {x:425,y:198,t:0},{x:495,y:322,t:1},{x:560,y:322,t:2},
   {x:655,y:158,t:0},{x:720,y:158,t:1},{x:860,y:218,t:2},{x:930,y:322,t:0},
   {x:1055,y:178,t:1},{x:1120,y:322,t:2},{x:1305,y:238,t:0},{x:1375,y:322,t:1},
   {x:1555,y:198,t:2},{x:1625,y:322,t:0},{x:1755,y:155,t:1},{x:1825,y:322,t:2},
   {x:2005,y:218,t:0},{x:2075,y:322,t:1},{x:2205,y:175,t:2},{x:2275,y:322,t:0},
   {x:2405,y:238,t:1},{x:2475,y:322,t:2},{x:2605,y:195,t:0},{x:2670,y:322,t:1}]
  .forEach(c=>collectibles.push({x:c.x,y:c.y,type:c.t,collected:false,bob:Math.random()*Math.PI*2,spin:Math.random()*Math.PI*2}));
}

// ===================== ENEMIES =====================
let enemies=[];
function generateEnemies(){
  enemies=[];
  [{x:360,y:328},{x:490,y:328},{x:710,y:328},{x:910,y:328},{x:1060,y:328},
   {x:1210,y:328},{x:1410,y:328},{x:1610,y:328},{x:1810,y:328},
   {x:2010,y:328},{x:2160,y:328},{x:2360,y:328},{x:2560,y:328},{x:2710,y:328}]
  .forEach(e=>enemies.push({x:e.x,y:e.y,w:36,h:36,vx:(Math.random()>.5?1:-1)*1.3,dead:false,deathTimer:0,eyeAngle:Math.random()*Math.PI*2,vy:0}));
}

// ===================== PLAYER =====================
let player={x:80,y:300,w:30,h:46,vx:0,vy:0,onGround:false,facing:1,invincible:0,animFrame:0,animTimer:0};

// ===================== INPUT =====================
document.addEventListener('keydown',e=>{keys[e.code]=true;if((e.code==='Space'||e.code==='ArrowUp')&&player.onGround&&gameRunning)jump();e.preventDefault();},{passive:false});
document.addEventListener('keyup',e=>{keys[e.code]=false;});
function jump(){player.vy=-14.5;player.onGround=false;sfxJump();}
function setupBtn(id,key){
  const b=document.getElementById(id);
  b.addEventListener('touchstart',e=>{keys[key]=true;b.classList.add('pressed');e.preventDefault();},{passive:false});
  b.addEventListener('touchend',e=>{keys[key]=false;b.classList.remove('pressed');e.preventDefault();},{passive:false});
  b.addEventListener('mousedown',()=>{keys[key]=true;b.classList.add('pressed');});
  b.addEventListener('mouseup',()=>{keys[key]=false;b.classList.remove('pressed');});
}
setupBtn('leftBtn','ArrowLeft');setupBtn('rightBtn','ArrowRight');
const jb=document.getElementById('jumpBtn');
jb.addEventListener('touchstart',e=>{if(player.onGround&&gameRunning)jump();jb.classList.add('pressed');e.preventDefault();},{passive:false});
jb.addEventListener('touchend',e=>{jb.classList.remove('pressed');e.preventDefault();},{passive:false});
jb.addEventListener('mousedown',()=>{if(player.onGround&&gameRunning)jump();jb.classList.add('pressed');});
jb.addEventListener('mouseup',()=>jb.classList.remove('pressed'));

// ===================== COLLISION =====================
function rectOverlap(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}
function resolvePlayer(){
  player.onGround=false;
  for(let p of platforms){
    if(rectOverlap(player,p)){
      const ox=Math.min(player.x+player.w,p.x+p.w)-Math.max(player.x,p.x);
      const oy=Math.min(player.y+player.h,p.y+p.h)-Math.max(player.y,p.y);
      if(oy<ox){
        if(player.vy>=0&&player.y+player.h-player.vy<=p.y+5){player.y=p.y-player.h;player.vy=0;player.onGround=true;}
        else if(player.vy<0){player.y=p.y+p.h;player.vy=0;}
      }else{if(player.x<p.x)player.x=p.x-player.w;else player.x=p.x+p.w;player.vx=0;}
    }
  }
}

// ===================== BACKGROUND =====================
const bgBuildings=[
  {x:40,y:195,w:58,h:165,c:'#ef9a9a'},{x:108,y:215,w:44,h:145,c:'#80cbc4'},
  {x:162,y:178,w:68,h:182,c:'#ffe082'},{x:240,y:205,w:52,h:155,c:'#a5d6a7'},
  {x:340,y:188,w:62,h:172,c:'#ef9a9a'},{x:412,y:215,w:48,h:145,c:'#80deea'},
  {x:480,y:172,w:74,h:188,c:'#ffe082'},{x:564,y:200,w:54,h:160,c:'#ce93d8'},
  {x:628,y:185,w:66,h:175,c:'#a5d6a7'},{x:704,y:210,w:48,h:150,c:'#ef9a9a'},
  {x:762,y:178,w:70,h:182,c:'#80cbc4'},{x:842,y:198,w:56,h:162,c:'#ffe082'},
  {x:908,y:172,w:75,h:188,c:'#ef9a9a'},{x:994,y:208,w:50,h:152,c:'#ce93d8'},
  {x:1054,y:182,w:68,h:178,c:'#80deea'},{x:1132,y:196,w:58,h:164,c:'#a5d6a7'},
  {x:1200,y:170,w:76,h:190,c:'#ffe082'},{x:1286,y:205,w:52,h:155,c:'#ef9a9a'},
  {x:1348,y:183,w:66,h:177,c:'#80cbc4'},{x:1424,y:212,w:48,h:148,c:'#ce93d8'},
  {x:1482,y:175,w:72,h:185,c:'#a5d6a7'},{x:1564,y:200,w:56,h:160,c:'#ffe082'},
  {x:1630,y:185,w:64,h:175,c:'#80deea'},{x:1704,y:210,w:50,h:150,c:'#ef9a9a'},
  {x:1764,y:175,w:72,h:185,c:'#ffe082'},{x:1846,y:198,w:56,h:162,c:'#a5d6a7'},
  {x:1912,y:170,w:76,h:190,c:'#80cbc4'},{x:1998,y:205,w:52,h:155,c:'#ce93d8'},
  {x:2060,y:182,w:68,h:178,c:'#ef9a9a'},{x:2138,y:196,w:58,h:164,c:'#ffe082'},
  {x:2206,y:172,w:74,h:188,c:'#80deea'},{x:2290,y:208,w:50,h:152,c:'#a5d6a7'},
  {x:2350,y:180,w:70,h:180,c:'#ef9a9a'},{x:2430,y:200,w:58,h:160,c:'#ce93d8'},
  {x:2498,y:174,w:74,h:186,c:'#ffe082'},{x:2582,y:205,w:52,h:155,c:'#80cbc4'},
  {x:2644,y:182,w:66,h:178,c:'#a5d6a7'},{x:2720,y:196,w:60,h:164,c:'#ef9a9a'},
];

// Seeded window pattern (static, not random each frame)
const windowSeeds=[];
for(let i=0;i<bgBuildings.length;i++){
  const b=bgBuildings[i];
  const ws=[];
  for(let wy=b.y+18;wy<b.y+b.h-16;wy+=22)
    for(let wx=9;wx<b.w-9;wx+=17)
      ws.push(((wx*7+wy*3+i*11)%17)>5);
  windowSeeds.push(ws);
}

function drawBackground(){
  const sky=ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,'#ff8a50');sky.addColorStop(0.35,'#ffb74d');
  sky.addColorStop(0.7,'#fff9c4');sky.addColorStop(1,'#e8f5e9');
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

  // Sun
  const sunX=680-camera.x*0.04,sunY=55;
  ctx.save();
  ctx.strokeStyle='rgba(255,236,179,0.4)';ctx.lineWidth=7;
  for(let i=0;i<12;i++){
    const a=(i/12)*Math.PI*2+frameCount*0.003;
    ctx.beginPath();ctx.moveTo(sunX+Math.cos(a)*46,sunY+Math.sin(a)*46);
    ctx.lineTo(sunX+Math.cos(a)*70,sunY+Math.sin(a)*70);ctx.stroke();
  }
  const sg=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,36);
  sg.addColorStop(0,'#fffde7');sg.addColorStop(0.6,'#ffee58');sg.addColorStop(1,'#ffca28');
  ctx.fillStyle=sg;ctx.shadowColor='rgba(255,200,50,0.5)';ctx.shadowBlur=35;
  ctx.beginPath();ctx.arc(sunX,sunY,36,0,Math.PI*2);ctx.fill();
  ctx.restore();

  // Clouds
  function cloud(x,y,s){
    ctx.save();ctx.fillStyle='rgba(255,255,255,0.86)';
    const cx2=x-camera.x*0.11;
    [{dx:0,dy:0,r:s},{dx:s*.44,dy:-s*.17,r:s*.72},{dx:s*.9,dy:0,r:s*.8},{dx:s*1.3,dy:-s*.1,r:s*.66}]
    .forEach(({dx,dy,r})=>{ctx.beginPath();ctx.arc(cx2+dx,y+dy,r,0,Math.PI*2);ctx.fill();});
    ctx.restore();
  }
  cloud(30,38,22);cloud(260,26,28);cloud(520,44,20);cloud(820,30,25);
  cloud(1100,48,22);cloud(1400,32,26);cloud(1700,46,20);cloud(2000,28,24);cloud(2350,42,22);

  // Buildings
  bgBuildings.forEach((b,bi)=>{
    const bx=b.x-camera.x*0.28;
    if(bx>W+80||bx+b.w<-80)return;
    ctx.fillStyle=b.c;
    ctx.beginPath();ctx.roundRect(bx,b.y,b.w,b.h,5);ctx.fill();
    ctx.fillStyle='rgba(0,0,0,0.07)';ctx.fillRect(bx+b.w-8,b.y+8,8,b.h-8);
    ctx.fillStyle='rgba(255,255,255,0.35)';
    ctx.beginPath();ctx.roundRect(bx,b.y,b.w,9,5);ctx.fill();
    let wi=0;
    for(let wy=b.y+18;wy<b.y+b.h-16;wy+=22){
      for(let wx=9;wx<b.w-9;wx+=17){
        ctx.fillStyle=windowSeeds[bi][wi]?'rgba(255,245,157,0.72)':'rgba(100,150,200,0.28)';
        ctx.beginPath();ctx.roundRect(bx+wx,wy,9,12,2);ctx.fill();
        wi++;
      }
    }
  });

  // Ocean
  const oc=ctx.createLinearGradient(0,H-28,0,H);
  oc.addColorStop(0,'rgba(2,136,209,0.5)');oc.addColorStop(1,'rgba(1,87,155,0.7)');
  ctx.fillStyle=oc;ctx.fillRect(0,H-28,W,28);
  ctx.strokeStyle='rgba(255,255,255,0.28)';ctx.lineWidth=2;
  for(let wx=(-camera.x*0.5)%60;wx<W;wx+=60){
    ctx.beginPath();ctx.arc(wx,H-14,16,Math.PI,Math.PI*2);ctx.stroke();
  }
}

// ===================== PLATFORMS =====================
function drawPlatforms(){
  platforms.forEach(p=>{
    const px=p.x-camera.x;
    if(px>W+60||px+p.w<-60)return;
    if(p.type==='ground'){
      ctx.fillStyle='#546e7a';ctx.fillRect(px,p.y+12,p.w,p.h-12);
      ctx.fillStyle='rgba(255,255,255,0.22)';
      for(let rx=px;rx<px+p.w;rx+=48)ctx.fillRect(rx+6,p.y+22,28,5);
      const gg=ctx.createLinearGradient(px,p.y,px,p.y+14);
      gg.addColorStop(0,'#81c784');gg.addColorStop(1,'#388e3c');
      ctx.fillStyle=gg;ctx.fillRect(px,p.y,p.w,14);
      ctx.fillStyle='#66bb6a';
      for(let gx=px+10;gx<px+p.w-10;gx+=22){ctx.beginPath();ctx.arc(gx,p.y,5,Math.PI,Math.PI*2);ctx.fill();}
    }else{
      ctx.fillStyle='rgba(0,0,0,0.17)';
      ctx.beginPath();ctx.ellipse(px+p.w/2,p.y+p.h+6,p.w/2-4,7,0,0,Math.PI*2);ctx.fill();
      const pg=ctx.createLinearGradient(px,p.y,px,p.y+p.h);
      pg.addColorStop(0,'#aed581');pg.addColorStop(0.4,'#7cb342');pg.addColorStop(1,'#558b2f');
      ctx.fillStyle=pg;ctx.beginPath();ctx.roundRect(px,p.y,p.w,p.h,8);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.26)';
      ctx.beginPath();ctx.ellipse(px+p.w/2,p.y+5,p.w/2-6,5,0,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#33691e';ctx.lineWidth=2;
      ctx.beginPath();ctx.roundRect(px,p.y,p.w,p.h,8);ctx.stroke();
      ctx.fillStyle='rgba(0,0,0,0.1)';
      for(let dx=px+14;dx<px+p.w-10;dx+=18){ctx.beginPath();ctx.arc(dx,p.y+p.h/2,3,0,Math.PI*2);ctx.fill();}
    }
  });
}

// ===================== COLLECTIBLES =====================
function drawCollectible(c){
  if(c.collected)return;
  const cx=c.x-camera.x;
  if(cx<-25||cx>W+25)return;
  const bob=Math.sin(c.bob+frameCount*0.07)*4;
  c.spin+=0.04;
  const cy=c.y+bob;
  ctx.save();ctx.shadowBlur=16;
  if(c.type===0){
    ctx.shadowColor='#00acc1';
    ctx.strokeStyle='rgba(0,188,212,0.32)';ctx.lineWidth=5;
    ctx.beginPath();ctx.arc(cx,cy,20,0,Math.PI*2);ctx.stroke();
    ctx.save();ctx.translate(cx,cy);ctx.rotate(c.spin);
    const dg=ctx.createConicGradient(0,0,0);
    dg.addColorStop(0,'#e1f5fe');dg.addColorStop(0.15,'#b2ebf2');dg.addColorStop(0.3,'#e040fb');
    dg.addColorStop(0.5,'#00bcd4');dg.addColorStop(0.7,'#76ff03');dg.addColorStop(0.85,'#ffca28');dg.addColorStop(1,'#e1f5fe');
    ctx.fillStyle=dg;ctx.beginPath();ctx.arc(0,0,16,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#222';ctx.beginPath();ctx.arc(0,0,4,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.5)';ctx.beginPath();ctx.ellipse(-5,-5,6,3,-0.5,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }else if(c.type===1){
    ctx.shadowColor='#ffa000';
    ctx.save();ctx.translate(cx,cy);
    ctx.fillStyle='#212121';ctx.beginPath();ctx.roundRect(-15,-11,30,22,4);ctx.fill();
    const kg=ctx.createLinearGradient(-13,-9,13,9);kg.addColorStop(0,'#ffca28');kg.addColorStop(1,'#ff8f00');
    ctx.fillStyle=kg;ctx.beginPath();ctx.roundRect(-13,-9,26,18,3);ctx.fill();
    ctx.fillStyle='#212121';ctx.beginPath();ctx.arc(-6,0,5,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(6,0,5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#616161';ctx.beginPath();ctx.arc(-6,0,3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(6,0,3,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#333';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(-4,-1);ctx.lineTo(4,-1);ctx.stroke();
    ctx.fillStyle='#fff';ctx.font='bold 6px "Baloo 2",sans-serif';
    ctx.textAlign='center';ctx.fillText('K7',0,-4);ctx.textAlign='left';
    ctx.restore();
  }else{
    ctx.shadowColor='#558b2f';
    ctx.save();ctx.translate(cx,cy);ctx.rotate(c.spin*0.5);
    ctx.fillStyle='#1a1a1a';ctx.beginPath();ctx.arc(0,0,16,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#2e2e2e';ctx.lineWidth=1.5;
    for(let r=9;r<=15;r+=2){ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.stroke();}
    const vg=ctx.createRadialGradient(0,0,0,0,0,7);
    vg.addColorStop(0,'#aed581');vg.addColorStop(1,'#558b2f');
    ctx.fillStyle=vg;ctx.beginPath();ctx.arc(0,0,7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold 5px "Baloo 2",sans-serif';
    ctx.textAlign='center';ctx.fillText('LBV',0,2);ctx.textAlign='left';
    ctx.fillStyle='rgba(255,255,255,0.25)';ctx.beginPath();ctx.ellipse(-5,-5,5,3,-0.4,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
  ctx.restore();
}

// ===================== ENEMY =====================
function drawEnemy(e){
  if(e.dead){
    if(e.deathTimer>0){
      const ex=e.x-camera.x;
      ctx.save();ctx.globalAlpha=e.deathTimer/30;
      ctx.font='28px serif';ctx.fillText('üí•',ex-14,e.y-(30-e.deathTimer)*0.8);
      ctx.restore();
    }return;
  }
  const ex=e.x-camera.x;
  if(ex<-60||ex>W+60)return;
  e.eyeAngle+=0.06;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.18)';
  ctx.beginPath();ctx.ellipse(ex+e.w/2,e.y+e.h+4,e.w/2,5,0,0,Math.PI*2);ctx.fill();
  const eg=ctx.createRadialGradient(ex+4,e.y+e.h-12,0,ex+4,e.y+e.h-12,16);
  eg.addColorStop(0,'#e57373');eg.addColorStop(1,'#b71c1c');
  ctx.fillStyle=eg;ctx.beginPath();ctx.ellipse(ex+4,e.y+e.h-12,15,12,-0.25,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#7f0000';ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(ex+4,e.y+e.h-12,15,12,-0.25,0,Math.PI*2);ctx.stroke();
  ctx.strokeStyle='#c62828';ctx.lineWidth=3.5;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(ex+18,e.y+e.h-12);ctx.lineTo(ex+18,e.y+3);ctx.stroke();
  ctx.strokeStyle='#c62828';ctx.lineWidth=2.5;
  ctx.beginPath();ctx.moveTo(ex+18,e.y+3);ctx.lineTo(ex+30,e.y+10);ctx.stroke();
  ctx.beginPath();ctx.moveTo(ex+18,e.y+10);ctx.lineTo(ex+28,e.y+17);ctx.stroke();
  ctx.strokeStyle='rgba(255,255,255,0.38)';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(ex-4,e.y+e.h-18);ctx.lineTo(ex+2,e.y+e.h-12);ctx.lineTo(ex-1,e.y+e.h-7);ctx.stroke();
  const ey2=Math.sin(e.eyeAngle)*1.5;
  ctx.fillStyle='#fff';
  ctx.beginPath();ctx.ellipse(ex-1,e.y+e.h-16+ey2,6,5,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(ex+10,e.y+e.h-16+ey2,6,5,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#b71c1c';
  ctx.beginPath();ctx.arc(ex,e.y+e.h-16+ey2,3.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(ex+11,e.y+e.h-16+ey2,3.5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';
  ctx.beginPath();ctx.arc(ex+1,e.y+e.h-18+ey2,1.2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(ex+12,e.y+e.h-18+ey2,1.2,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#7f0000';ctx.lineWidth=2.5;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(ex-6,e.y+e.h-24+ey2);ctx.lineTo(ex+4,e.y+e.h-21+ey2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(ex+5,e.y+e.h-21+ey2);ctx.lineTo(ex+15,e.y+e.h-24+ey2);ctx.stroke();
  ctx.strokeStyle='#7f0000';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(ex-4,e.y+e.h-7);ctx.lineTo(ex-1,e.y+e.h-5);ctx.lineTo(ex+2,e.y+e.h-7);ctx.lineTo(ex+5,e.y+e.h-5);ctx.lineTo(ex+8,e.y+e.h-7);ctx.stroke();
  ctx.restore();
}

// ===================== PLAYER =====================
function drawPlayer(){
  if(player.invincible>0&&Math.floor(player.invincible/5)%2===0)return;
  const px=player.x-camera.x, py=player.y;
  ctx.save();
  ctx.translate(px+player.w/2,0);
  ctx.scale(player.facing,1);
  const ox=-player.w/2;

  ctx.fillStyle='rgba(0,0,0,0.17)';
  ctx.beginPath();ctx.ellipse(0,py+player.h+3,player.w/2+2,6,0,0,Math.PI*2);ctx.fill();

  const isWalking=player.onGround&&Math.abs(player.vx)>0.5;
  const legSwing=isWalking?Math.sin(frameCount*0.32)*10:0;
  const armSwing=isWalking?Math.cos(frameCount*0.32)*8:0;

  // Shoes
  ctx.fillStyle='#212121';
  ctx.beginPath();ctx.ellipse(ox+5+legSwing*0.4,py+player.h+2,11,6,-0.1,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(ox+25-legSwing*0.4,py+player.h+2,11,6,0.1,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.45)';
  ctx.fillRect(ox+1,py+player.h-1,8,3);ctx.fillRect(ox+21,py+player.h-1,8,3);

  // Jeans
  const jg=ctx.createLinearGradient(ox,py+26,ox+14,py+26);
  jg.addColorStop(0,'#1565c0');jg.addColorStop(1,'#0d47a1');
  ctx.fillStyle=jg;
  ctx.beginPath();ctx.roundRect(ox+2+legSwing*0.3,py+26,12,player.h-28,4);ctx.fill();
  ctx.fillStyle='#1565c0';
  ctx.beginPath();ctx.roundRect(ox+16-legSwing*0.3,py+26,12,player.h-28,4);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.12)';
  ctx.fillRect(ox+4,py+28,4,14);ctx.fillRect(ox+18,py+28,4,14);

  // T-shirt
  const tg=ctx.createLinearGradient(ox,py+13,ox+player.w,py+30);
  tg.addColorStop(0,'#ffffff');tg.addColorStop(1,'#f0f0f0');
  ctx.fillStyle=tg;ctx.beginPath();ctx.roundRect(ox+1,py+13,player.w-2,16,6);ctx.fill();
  ctx.fillStyle='rgba(0,0,0,0.05)';ctx.fillRect(ox+1,py+22,player.w-2,7);
  ctx.fillStyle='#2e7d32';ctx.font='bold 13px serif';
  ctx.textAlign='center';ctx.fillText('‚ô™',0,py+25);ctx.textAlign='left';

  // Arms
  ctx.fillStyle='#8d5524';
  ctx.beginPath();ctx.roundRect(ox-9,py+14+armSwing*0.3,11,15,5);ctx.fill();
  ctx.beginPath();ctx.roundRect(ox+player.w-2,py+14-armSwing*0.3,11,15,5);ctx.fill();

  // Neck
  ctx.fillStyle='#8d5524';ctx.beginPath();ctx.roundRect(ox+9,py+7,12,9,4);ctx.fill();

  // Head
  const hg=ctx.createRadialGradient(ox+15,py+3,0,ox+15,py+5,17);
  hg.addColorStop(0,'#a0692a');hg.addColorStop(1,'#7b4a1e');
  ctx.fillStyle=hg;ctx.beginPath();ctx.ellipse(ox+15,py+5,16,14,0,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.13)';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.ellipse(ox+15,py+5,16,14,0,0,Math.PI*2);ctx.stroke();

  // Hair
  ctx.fillStyle='#111';
  ctx.beginPath();ctx.ellipse(ox+15,py-4,15,9,0,Math.PI,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.roundRect(ox+1,py-5,28,8,0);ctx.fill();
  ctx.fillStyle='#1a1a1a';
  ctx.beginPath();ctx.ellipse(ox+1,py+3,4,8,-.3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(ox+29,py+3,4,8,.3,0,Math.PI*2);ctx.fill();

  // Eye
  ctx.fillStyle='#fff';ctx.beginPath();ctx.ellipse(ox+22,py+5,6,5,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#3e2000';ctx.beginPath();ctx.arc(ox+23,py+6,3.8,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(ox+24,py+4,1.4,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#111';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(ox+22,py+5,6,Math.PI+0.4,Math.PI*2-0.4);ctx.stroke();

  // Smile
  ctx.strokeStyle='#3e2000';ctx.lineWidth=2;ctx.lineCap='round';
  ctx.beginPath();ctx.arc(ox+17,py+11,5,0.1,Math.PI-0.1);ctx.stroke();

  ctx.restore();
}

// ===================== HUD =====================
function drawHUD(){
  ctx.fillStyle='rgba(0,0,0,0.4)';
  ctx.beginPath();ctx.roundRect(0,0,W,34,0);ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 17px "Baloo 2",sans-serif';
  ctx.fillText(`üíø ${score} pts`,12,23);
  ctx.textAlign='center';ctx.fillText(`‚ù§Ô∏è ${lives}`,W/2,23);
  ctx.textAlign='right';ctx.fillText(`üèÜ ${score}`,W-12,23);
  ctx.textAlign='left';
}

// ===================== PARTICLES =====================
let particles=[];
function spawnParticles(x,y,color,n=8){
  for(let i=0;i<n;i++){
    const a=(Math.PI*2/n)*i+Math.random()*0.5,spd=2.5+Math.random()*3;
    particles.push({x,y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-2.5,life:35,color,size:4+Math.random()*5});
  }
}
function updateParticles(){
  particles=particles.filter(p=>p.life>0);
  for(let p of particles){
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.25;p.life--;
    ctx.save();ctx.globalAlpha=p.life/35;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x-camera.x,p.y,p.size*(p.life/35),0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

// ===================== LOGIC =====================
function updatePlayer(){
  const spd=4.8;
  if(keys['ArrowLeft']){player.vx=-spd;player.facing=-1;}
  else if(keys['ArrowRight']){player.vx=spd;player.facing=1;}
  else player.vx*=0.72;
  if((keys['ArrowUp']||keys['Space'])&&player.onGround)jump();
  player.vy+=0.65;if(player.vy>18)player.vy=18;
  player.x+=player.vx;player.y+=player.vy;
  if(player.x<0){player.x=0;player.vx=0;}
  resolvePlayer();
  camera.x=Math.max(0,player.x-W*0.35);
  if(player.y>H+60)playerDie();
  if(player.invincible>0)player.invincible--;
  player.animTimer++;if(player.animTimer>8){player.animFrame=(player.animFrame+1)%4;player.animTimer=0;}
}
function updateEnemies(){
  for(let e of enemies){
    if(e.dead){if(e.deathTimer>0)e.deathTimer--;continue;}
    e.eyeAngle+=0.05;e.x+=e.vx;
    for(let p of platforms){
      const r={x:e.x,y:e.y,w:e.w,h:e.h};
      if(rectOverlap(r,p)){
        if(e.vy>=0&&e.y+e.h-e.vy<=p.y+5){e.y=p.y-e.h;e.vy=0;}
        if(e.x<=p.x||e.x+e.w>=p.x+p.w)e.vx*=-1;
      }
    }
    e.vy=(e.vy||0)+0.5;e.y+=e.vy;
    if(e.y>H+60){e.dead=true;e.deathTimer=0;continue;}
    if(player.invincible===0&&rectOverlap(player,{x:e.x,y:e.y,w:e.w,h:e.h})){
      if(player.vy>0&&player.y+player.h<e.y+e.h/2+6){
        e.dead=true;e.deathTimer=30;player.vy=-11;score+=50;
        sfxStomp();spawnParticles(e.x+e.w/2,e.y,'#ef5350',10);updateHUD();
      }else playerDie();
    }
  }
}
function updateCollectibles(){
  for(let c of collectibles){
    if(c.collected)continue;
    if(rectOverlap(player,{x:c.x-14,y:c.y-14,w:28,h:28})){
      c.collected=true;
      const cols=['#00acc1','#ffa000','#7cb342'],pts=[10,20,30];
      spawnParticles(c.x,c.y,cols[c.type],12);
      sfxCollect(c.type);score+=pts[c.type];updateHUD();
    }
  }
}
function playerDie(){
  if(player.invincible>0)return;
  lives--;player.invincible=120;
  spawnParticles(player.x+player.w/2,player.y+player.h/2,'#ef5350',14);
  document.getElementById('livesDisplay').textContent=lives;
  if(lives<=0){sfxDie();setTimeout(gameOver,500);}
  else{sfxHurt();player.x=80;player.y=300;player.vx=0;player.vy=0;camera.x=0;}
}
function updateHUD(){
  document.getElementById('scoreDisplay').textContent=score;
  document.getElementById('livesDisplay').textContent=lives;
  document.getElementById('totalDisplay').textContent=score;
}
function gameOver(){
  gameRunning=false;
  const ov=document.getElementById('overlay');
  ov.innerHTML=`<h1>üíî GAME OVER</h1><p>Score final : ${score} pts</p><p>Hokube continue son aventure √† LBV !</p><button class="overlay-btn" onclick="startGame()" style="background:linear-gradient(135deg,#e53935,#b71c1c);">üîÑ &nbsp;REJOUER</button>`;
  ov.style.display='flex';
}
function checkWin(){
  if(player.x>2720){
    gameRunning=false;sfxWin();
    const ov=document.getElementById('overlay');
    ov.innerHTML=`<h1>üéâ VICTOIRE ! üéâ</h1><p>Bravo Hokube ! L'aventure √† Libreville est termin√©e !</p><p>Score : ${score} pts</p><p>üíø Collectibles : ${collectibles.filter(c=>c.collected).length} / ${collectibles.length}</p><button class="overlay-btn" onclick="startGame()">üîÑ &nbsp;REJOUER</button>`;
    ov.style.display='flex';
  }
}

// ===================== LOOP =====================
function gameLoop(){
  if(!gameRunning)return;
  frameCount++;
  ctx.clearRect(0,0,W,H);
  drawBackground();
  drawPlatforms();
  for(let c of collectibles)drawCollectible(c);
  updateEnemies();
  for(let e of enemies)drawEnemy(e);
  updatePlayer();
  updateCollectibles();
  drawPlayer();
  updateParticles();
  drawHUD();
  checkWin();
  requestAnimationFrame(gameLoop);
}

function startGame(){
  initAudio();
  score=0;lives=3;frameCount=0;
  player={x:80,y:300,w:30,h:46,vx:0,vy:0,onGround:false,facing:1,invincible:0,animFrame:0,animTimer:0};
  camera={x:0};particles=[];keys={};
  generateCollectibles();generateEnemies();updateHUD();
  document.getElementById('overlay').style.display='none';
  gameRunning=true;gameLoop();
}
</script>
</body>
</html>
