<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HOKUBE</title>

<!-- Favicons (mets ces fichiers à la racine du repo, au même niveau que index.html) -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="manifest" href="site.webmanifest">
<link rel="shortcut icon" href="favicon.ico">
  
<style>
:root{
  --bg:#000;
  --fg:#fff;
  --bar-bg:rgba(0,0,0,.92);
  --hair:rgba(255,255,255,.12);
  --sheet:rgba(0,0,0,.35);
  --cover-bg:rgba(0,0,0,.15);

  /* FX */
  --fxText: rgb(255, 65, 65);
  --fxGradient: transparent;
}

@media (prefers-color-scheme: light){
  :root{
    --bg:#fff;
    --fg:#000;
    --bar-bg:rgba(255,255,255,.92);
    --hair:rgba(0,0,0,.12);
    --sheet:rgba(255,255,255,.35);
    --cover-bg:rgba(0,0,0,.04);

    --fxText: rgb(200, 0, 0);
  }
}

*{ box-sizing:border-box; }

html, body{
  margin:0;
  min-height:100%;
  background:var(--bg);
  color:var(--fg);
  font-family:Arial, sans-serif;
  font-weight:700;
}

/* Transitions globales */
body{
  position:relative;
  transition: color 5s ease;
}

/* Couche gradient animée */
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  pointer-events:none;
  opacity:0;
  transition: opacity 5s ease;
  background: var(--fxGradient, transparent);
}

/* FX actif */
body.fx{ color: var(--fxText); }
body.fx::before{ opacity:1; }

/* Frame séparée en haut */
.topbar{
  position:sticky;
  top:0;
  z-index:10;
  background:var(--bar-bg);
  backdrop-filter:saturate(180%) blur(10px);
  border-bottom:1px solid var(--hair);
}

.topbar-inner{
  max-width:1100px;
  margin:0 auto;
  padding:18px 18px;
  text-align:center;
}

.topbar h1{
  margin:0;
  font-weight:700;
  letter-spacing:6px;
  font-size:14px;
  cursor:pointer;
  user-select:none;
  display:inline-block;
  padding:6px 8px;
  border-radius:10px;
}

.topbar h1:focus-visible{
  outline:2px solid currentColor;
  outline-offset:3px;
}

/* Contenu */
.main{
  max-width:1100px;
  margin:0 auto;
  padding:26px 18px 44px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));
  gap:26px;
}

.card{
  text-decoration:none;
  color:inherit;
  display:block;
}

.cover-wrap{
  position:relative;
  overflow:hidden;
}

.cover{
  width:100%;
  aspect-ratio:1/1;
  object-fit:contain;
  background:var(--cover-bg);
  display:block;
  transition:transform .22s ease, filter .22s ease;
}

/* Overlay année */
.year{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:"Courier New", Courier, monospace;
  font-size:16px;
  font-weight:700;
  letter-spacing:3px;
  color:#fff;
  opacity:0;
  transition:opacity .22s ease;
  pointer-events:none;
}

.card:hover .cover{
  transform:scale(1.02);
  filter:brightness(70%);
}
.card:hover .year{ opacity:1; }

.title{
  margin-top:10px;
  font-family:"Courier New", Courier, monospace;
  font-size:10px;
  text-transform:uppercase;
  text-align:center;
  opacity:.78;
  font-weight:700;
}

/* Footer insta */
.footer{
  display:flex;
  justify-content:center;
  padding:26px 0 10px;
}

.instagram{
  width:18px;
  height:18px;
  fill:currentColor;
  opacity:.6;
  transition:opacity .2s ease;
}
.instagram:hover{ opacity:1; }

/* ---- Drum machine ---- */
.hidden{ display:none !important; }

.drum{
  max-width:980px;
  margin:0 auto;
  border:1px solid var(--hair);
  border-radius:18px;
  padding:16px;
  background: color-mix(in oklab, var(--bar-bg) 75%, transparent);
  backdrop-filter:saturate(180%) blur(10px);
}

.drum-top{
  display:flex;
  flex-wrap:wrap;
  gap:10px 12px;
  align-items:center;
  justify-content:space-between;
  padding-bottom:12px;
  border-bottom:1px solid var(--hair);
  margin-bottom:14px;
}

.drum-title{
  font-family:"Courier New", Courier, monospace;
  letter-spacing:2px;
  font-size:11px;
  opacity:.9;
}

.controls{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:10px;
}

.btn{
  border:1px solid var(--hair);
  background:transparent;
  color:inherit;
  padding:10px 12px;
  font-size:10px;
  letter-spacing:2px;
  font-family:"Courier New", Courier, monospace;
  cursor:pointer;
  border-radius:12px;
  background-color:var(--sheet);
  backdrop-filter: blur(8px);
}
.btn:active{ transform: translateY(1px); }
.btn:focus-visible{
  outline:2px solid currentColor;
  outline-offset:3px;
}

.ctrl{
  display:flex;
  align-items:center;
  gap:10px;
  font-family:"Courier New", Courier, monospace;
  font-size:10px;
  letter-spacing:2px;
}
.ctrl input[type="range"]{ width:160px; }

.stepgrid{
  display:grid;
  grid-template-columns: 90px 1fr;
  gap:10px;
}

.rowlabel{
  font-family:"Courier New", Courier, monospace;
  font-size:10px;
  letter-spacing:2px;
  text-transform:uppercase;
  opacity:.85;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  padding-right:8px;
}

.steps{
  display:grid;
  grid-template-columns: repeat(16, minmax(0, 1fr));
  gap:6px;
}

.step{
  height:34px;
  border-radius:10px;
  border:1px solid var(--hair);
  background:transparent;
  cursor:pointer;
  position:relative;
  overflow:hidden;
}

/* ON */
.step.on{
  background: color-mix(in oklab, currentColor 18%, transparent);
  border-color: color-mix(in oklab, currentColor 45%, var(--hair));
}

/* ACCENT (plus fort) */
.step.accent{
  background: color-mix(in oklab, currentColor 30%, transparent);
  border-color: color-mix(in oklab, currentColor 65%, var(--hair));
}
.step.accent::before{
  content:"";
  position:absolute;
  left:7px;
  top:7px;
  width:6px;
  height:6px;
  border-radius:99px;
  background: currentColor;
  opacity:.75;
}

.step.playhead::after{
  content:"";
  position:absolute;
  inset:0;
  border:1px solid currentColor;
  border-radius:10px;
  opacity:.6;
  pointer-events:none;
}

.hint{
  margin-top:12px;
  font-family:"Courier New", Courier, monospace;
  font-size:10px;
  letter-spacing:1.5px;
  opacity:.75;
}

@media (max-width:520px){
  .grid{
    grid-template-columns:repeat(2, minmax(0, 1fr));
    gap:18px;
  }
  .stepgrid{ grid-template-columns: 70px 1fr; }
  .step{ height:32px; }
  .ctrl input[type="range"]{ width:140px; }
}

@media (prefers-reduced-motion: reduce){
  body{ transition:none; }
  body::before{ transition:none; }
  .cover, .year, .instagram{ transition:none; }
}
</style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <h1 id="brand" tabindex="0" role="button" aria-pressed="false" aria-label="Basculer entre albums et boîte à rythme">HOKUBE</h1>
    </div>
  </header>

  <main class="main">

    <!-- VUE ALBUMS -->
    <div id="albumsView">
      <div class="grid">

        <a class="card" href="https://AlterK.lnk.to/ItsYours" target="_blank" rel="noopener noreferrer">
          <div class="cover-wrap">
            <img class="cover" src="https://cdn-images.dzcdn.net/images/cover/c35add38d8863b9ff17f49214d0ce311/500x500-000000-80-0-0.jpg" alt="NO LOVE LOST">
            <div class="year">2026</div>
          </div>
          <div class="title">NO LOVE LOST</div>
        </a>

        <a class="card" href="https://distrokid.com/hyperfollow/hokube/when-it-went-quiet-vol-2" target="_blank" rel="noopener noreferrer">
          <div class="cover-wrap">
            <img class="cover" src="https://cdn-images.dzcdn.net/images/cover/728a4adffac9df9e590eaaf26b507c56/500x500-000000-80-0-0.jpg" alt="WHEN IT WENT QUIET, VOL.2">
            <div class="year">2025</div>
          </div>
          <div class="title">WHEN IT WENT QUIET, VOL.2</div>
        </a>

        <a class="card" href="https://distrokid.com/hyperfollow/ishsankaraandhokube/blvck-hundred" target="_blank" rel="noopener noreferrer">
          <div class="cover-wrap">
            <img class="cover" src="https://cdn-images.dzcdn.net/images/cover/8e6132c1795811e8e3bdfb1bb009f119/500x500-000000-80-0-0.jpg" alt="BLVCK HUNDRED">
            <div class="year">2022</div>
          </div>
          <div class="title">BLVCK HUNDRED</div>
        </a>

        <a class="card" href="https://AlterK.lnk.to/WhenItWentQuietVol1" target="_blank" rel="noopener noreferrer">
          <div class="cover-wrap">
            <img class="cover" src="https://cdn-images.dzcdn.net/images/cover/bdcee8337f6da598fd0aad7b8503b561/500x500-000000-80-0-0.jpg" alt="WHEN IT WENT QUIET, VOL.1">
            <div class="year">2022</div>
          </div>
          <div class="title">WHEN IT WENT QUIET, VOL.1</div>
        </a>

        <a class="card" href="https://pschent.lnk.to/Hokube-Givelove-Getitback" target="_blank" rel="noopener noreferrer">
          <div class="cover-wrap">
            <img class="cover" src="https://cdn-images.dzcdn.net/images/cover/cf59253dc3658e146032dcd6d4a60c0a/500x500-000000-80-0-0.jpg" alt="GIVE LOVE, GET IT BACK">
            <div class="year">2020</div>
          </div>
          <div class="title">GIVE LOVE, GET IT BACK</div>
        </a>

        <a class="card" href="https://distrokid.com/hyperfollow/hokube/this-album-needs-a-title" target="_blank" rel="noopener noreferrer">
          <div class="cover-wrap">
            <img class="cover" src="https://cdn-images.dzcdn.net/images/cover/4c9264eed54fbec9f7a185699c6342b7/500x500-000000-80-0-0.jpg" alt="THIS ALBUM NEEDS A TITLE">
            <div class="year">2019</div>
          </div>
          <div class="title">THIS ALBUM NEEDS A TITLE</div>
        </a>

        <a class="card" href="https://distrokid.com/hyperfollow/hokube/gaoU" target="_blank" rel="noopener noreferrer">
          <div class="cover-wrap">
            <img class="cover" src="https://cdn-images.dzcdn.net/images/cover/f18444ff29b9aee19cb35f64d1ce1c1e/500x500-000000-80-0-0.jpg" alt="I HAD TO DO THIS AT SOME POINT EP">
            <div class="year">2015</div>
          </div>
          <div class="title">I HAD TO DO THIS AT SOME POINT EP</div>
        </a>

        <a class="card" href="https://distrokid.com/hyperfollow/ishsankaraandhokubeandmikemef/tromlife" target="_blank" rel="noopener noreferrer">
          <div class="cover-wrap">
            <img class="cover" src="https://cdn-images.dzcdn.net/images/cover/7280613520308035eb623ecae303d4c0/500x500-000000-80-0-0.jpg" alt="T.R.O.M.LIFE">
            <div class="year">2019</div>
          </div>
          <div class="title">T.R.O.M.LIFE</div>
        </a>

      </div>

      <div class="footer">
        <a href="https://instagram.com/hokube" target="_blank" rel="noopener noreferrer" aria-label="Instagram Hokube">
          <svg class="instagram" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 2C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5H7zm10 2c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3h10zm-5 3.5A4.5 4.5 0 1 0 16.5 12 4.5 4.5 0 0 0 12 7.5zm0 7A2.5 2.5 0 1 1 14.5 12 2.5 2.5 0 0 1 12 14.5zM17.8 6.2a1 1 0 1 0 1 1 1 1 0 0 0-1-1z"/>
          </svg>
        </a>
      </div>
    </div>

    <!-- VUE DRUM MACHINE -->
    <section id="drumView" class="hidden" aria-label="Boîte à rythme">
      <div class="drum">
        <div class="drum-top">
          <div class="drum-title">HOKUBE BEAT LAB / 16 STEPS</div>

          <div class="controls">
            <button class="btn" id="startStop" type="button">START</button>

            <div class="ctrl">
              <span>BPM</span>
              <input id="bpm" type="range" min="70" max="170" value="120">
              <span id="bpmVal">120</span>
            </div>

            <div class="ctrl">
              <span>SWING</span>
              <!-- 50 = straight, jusqu'à 75 = bien swingué -->
              <input id="swing" type="range" min="50" max="75" value="50">
              <span id="swingVal">50</span>
            </div>

            <button class="btn" id="clear" type="button">CLEAR</button>
          </div>
        </div>

        <div class="stepgrid" id="stepgrid"></div>

        <div class="hint">
          Click : OFF → ON → ACCENT. &nbsp; | &nbsp; Clique sur HOKUBE pour revenir aux albums.
        </div>
      </div>
    </section>

  </main>

<script>
/* ---------------- Shake gradient (inchangé) ---------------- */
let lastTime = 0;
const shakeThreshold = 14;
let lastX = null, lastY = null, lastZ = null;

const FADE_MS = 5000;
const HOLD_MS = 5000;
const RESET_AFTER_MS = FADE_MS + HOLD_MS;
let resetTimer = null;

function coolPastelHsl(){
  const h = 140 + Math.floor(Math.random() * (290 - 140 + 1));
  const s = 42 + Math.floor(Math.random() * 14);
  const l = 76 + Math.floor(Math.random() * 8);
  return `hsl(${h} ${s}% ${l}%)`;
}

function applyGradient(){
  const c1 = coolPastelHsl();
  const c2 = coolPastelHsl();
  const c3 = coolPastelHsl();
  document.body.style.setProperty("--fxGradient", `linear-gradient(135deg, ${c1}, ${c2}, ${c3})`);
  document.body.classList.add("fx");
}

function resetNeutral(){
  document.body.classList.remove("fx");
  setTimeout(() => document.body.style.removeProperty("--fxGradient"), FADE_MS + 200);
}

function scheduleReset(){
  if(resetTimer) clearTimeout(resetTimer);
  resetTimer = setTimeout(resetNeutral, RESET_AFTER_MS);
}

function triggerFx(){
  applyGradient();
  scheduleReset();
}

function handleMotion(event){
  const acc = event.accelerationIncludingGravity;
  if(!acc) return;

  if(lastX !== null){
    const dx = Math.abs(lastX - acc.x);
    const dy = Math.abs(lastY - acc.y);
    const dz = Math.abs(lastZ - acc.z);

    if(dx + dy + dz > shakeThreshold){
      const now = Date.now();
      if(now - lastTime > 900){
        triggerFx();
        lastTime = now;
      }
    }
  }

  lastX = acc.x;
  lastY = acc.y;
  lastZ = acc.z;
}

function enableMotion(){
  if(typeof DeviceMotionEvent !== "undefined" &&
     typeof DeviceMotionEvent.requestPermission === "function"){
    DeviceMotionEvent.requestPermission()
      .then(res => {
        if(res === "granted"){
          window.addEventListener("devicemotion", handleMotion, { passive:true });
          const b = document.getElementById("motionBtn");
          if(b) b.remove();
        }
      })
      .catch(()=>{});
  } else {
    window.addEventListener("devicemotion", handleMotion, { passive:true });
  }
}

if(typeof DeviceMotionEvent !== "undefined" &&
   typeof DeviceMotionEvent.requestPermission === "function"){
  const btn = document.createElement("button");
  btn.id = "motionBtn";
  btn.type = "button";
  btn.textContent = "ENABLE MOTION";
  btn.onclick = enableMotion;

  btn.style.position = "fixed";
  btn.style.right = "14px";
  btn.style.bottom = "14px";
  btn.style.zIndex = "20";
  btn.style.background = "transparent";
  btn.style.color = "var(--fg)";
  btn.style.border = "1px solid var(--hair)";
  btn.style.padding = "10px 12px";
  btn.style.fontSize = "10px";
  btn.style.letterSpacing = "2px";
  btn.style.fontFamily = '"Courier New", Courier, monospace';
  btn.style.cursor = "pointer";
  btn.style.backdropFilter = "blur(8px)";
  btn.style.backgroundColor = "var(--sheet)";

  document.body.appendChild(btn);
} else {
  window.addEventListener("devicemotion", handleMotion, { passive:true });
}

/* ---------------- Toggle Albums <-> Drum ---------------- */
const brand = document.getElementById("brand");
const albumsView = document.getElementById("albumsView");
const drumView = document.getElementById("drumView");

function toggleView(){
  const showingAlbums = !albumsView.classList.contains("hidden");
  if(showingAlbums){
    albumsView.classList.add("hidden");
    drumView.classList.remove("hidden");
    brand.setAttribute("aria-pressed", "true");
  }else{
    drumView.classList.add("hidden");
    albumsView.classList.remove("hidden");
    brand.setAttribute("aria-pressed", "false");
    stop();
  }
}

brand.addEventListener("click", toggleView);
brand.addEventListener("keydown", (e) => {
  if(e.key === "Enter" || e.key === " "){
    e.preventDefault();
    toggleView();
  }
});

/* ---------------- Drum machine (Accent + Swing) ---------------- */
const stepgridEl = document.getElementById("stepgrid");
const bpmEl = document.getElementById("bpm");
const bpmValEl = document.getElementById("bpmVal");
const swingEl = document.getElementById("swing");
const swingValEl = document.getElementById("swingVal");
const startStopEl = document.getElementById("startStop");
const clearEl = document.getElementById("clear");

const tracks = [
  { name: "KICK",  id:"kick"  },
  { name: "SNARE", id:"snare" },
  { name: "HAT",   id:"hat"   },
  { name: "CLAP",  id:"clap"  },
];

const stepsCount = 16;

/**
 * pattern[track][step] :
 * 0 = off
 * 1 = on
 * 2 = accent
 */
let pattern = {};
tracks.forEach(t => pattern[t.id] = new Array(stepsCount).fill(0));

function buildGrid(){
  stepgridEl.innerHTML = "";
  tracks.forEach((t) => {
    const label = document.createElement("div");
    label.className = "rowlabel";
    label.textContent = t.name;
    stepgridEl.appendChild(label);

    const steps = document.createElement("div");
    steps.className = "steps";

    for(let i=0;i<stepsCount;i++){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "step";
      b.setAttribute("aria-label", `${t.name} step ${i+1}`);
      b.dataset.track = t.id;
      b.dataset.step = String(i);

      const render = () => {
        const v = pattern[t.id][i];
        b.classList.toggle("on", v === 1 || v === 2);
        b.classList.toggle("accent", v === 2);
      };

      b.addEventListener("click", () => {
        const v = pattern[t.id][i];
        const next = (v + 1) % 3; // 0->1->2->0
        pattern[t.id][i] = next;
        render();

        if(audioReady()){
          const vel = next === 2 ? 1.0 : next === 1 ? 0.72 : 0;
          if(vel > 0) playSound(t.id, ctx.currentTime, vel);
        }
      });

      render();
      steps.appendChild(b);
    }

    stepgridEl.appendChild(steps);
  });
}
buildGrid();

/* Controls */
bpmEl.addEventListener("input", () => bpmValEl.textContent = bpmEl.value);
swingEl.addEventListener("input", () => swingValEl.textContent = swingEl.value);

/* Audio (WebAudio) */
let ctx = null;
let master = null;

function audioReady(){
  return ctx && ctx.state !== "closed";
}

async function ensureAudio(){
  if(!ctx){
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = 0.9;
    master.connect(ctx.destination);
  }
  if(ctx.state === "suspended"){
    await ctx.resume();
  }
}

function whiteNoiseBuffer(duration=0.25){
  const sampleRate = ctx.sampleRate;
  const length = Math.floor(sampleRate * duration);
  const buffer = ctx.createBuffer(1, length, sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<length;i++) data[i] = (Math.random()*2 - 1);
  return buffer;
}

let noiseBuf = null;

function playKick(time, vel){
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "sine";
  osc.frequency.setValueAtTime(140, time);
  osc.frequency.exponentialRampToValueAtTime(45, time + 0.12);

  const peak = 1.0 * vel;
  gain.gain.setValueAtTime(peak, time);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.25);

  osc.connect(gain);
  gain.connect(master);

  osc.start(time);
  osc.stop(time + 0.3);
}

function playSnare(time, vel){
  if(!noiseBuf) noiseBuf = whiteNoiseBuffer(0.25);

  const noise = ctx.createBufferSource();
  noise.buffer = noiseBuf;

  const bp = ctx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.setValueAtTime(1800, time);
  bp.Q.setValueAtTime(0.7, time);

  const gain = ctx.createGain();
  gain.gain.setValueAtTime(0.9 * vel, time);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.18);

  noise.connect(bp);
  bp.connect(gain);
  gain.connect(master);

  const osc = ctx.createOscillator();
  const og = ctx.createGain();
  osc.type = "triangle";
  osc.frequency.setValueAtTime(190, time);
  og.gain.setValueAtTime(0.25 * vel, time);
  og.gain.exponentialRampToValueAtTime(0.001, time + 0.12);
  osc.connect(og);
  og.connect(master);

  noise.start(time);
  noise.stop(time + 0.2);
  osc.start(time);
  osc.stop(time + 0.2);
}

function playHat(time, vel){
  if(!noiseBuf) noiseBuf = whiteNoiseBuffer(0.12);

  const noise = ctx.createBufferSource();
  noise.buffer = noiseBuf;

  const hp = ctx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.setValueAtTime(6500, time);

  const gain = ctx.createGain();
  gain.gain.setValueAtTime(0.35 * vel, time);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.07);

  noise.connect(hp);
  hp.connect(gain);
  gain.connect(master);

  noise.start(time);
  noise.stop(time + 0.11);
}

function playClap(time, vel){
  if(!noiseBuf) noiseBuf = whiteNoiseBuffer(0.25);

  const noise = ctx.createBufferSource();
  noise.buffer = noiseBuf;

  const bp = ctx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.setValueAtTime(2200, time);
  bp.Q.setValueAtTime(0.8, time);

  const gain = ctx.createGain();
  const k = vel;

  gain.gain.setValueAtTime(0.0001, time);
  gain.gain.exponentialRampToValueAtTime(0.7*k, time + 0.005);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
  gain.gain.setValueAtTime(0.0001, time + 0.045);
  gain.gain.exponentialRampToValueAtTime(0.55*k, time + 0.05);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.085);
  gain.gain.setValueAtTime(0.0001, time + 0.1);
  gain.gain.exponentialRampToValueAtTime(0.45*k, time + 0.105);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.16);

  noise.connect(bp);
  bp.connect(gain);
  gain.connect(master);

  noise.start(time);
  noise.stop(time + 0.2);
}

function playSound(trackId, time, vel){
  if(!ctx) return;
  if(trackId === "kick")  playKick(time, vel);
  if(trackId === "snare") playSnare(time, vel);
  if(trackId === "hat")   playHat(time, vel);
  if(trackId === "clap")  playClap(time, vel);
}

/* Sequencer */
let isPlaying = false;
let stepIndex = 0;
let timerId = null;

function stepDurationSec(){
  const bpm = Number(bpmEl.value);
  return (60 / bpm) / 4; // 16èmes
}

/**
 * Swing:
 * - slider 50..75
 * - 50 = straight
 * - on retarde les steps impaires (1,3,5...) dans chaque paire (2*16ème)
 */
function swingDelaySec(){
  const s = Number(swingEl.value);     // 50..75
  const step = stepDurationSec();
  const pair = step * 2;
  const r = s / 100;                  // 0.50..0.75
  return Math.max(0, pair * r - step); // 0..(step*0.5)
}

function updatePlayheadUI(prev, next){
  const allSteps = stepgridEl.querySelectorAll(".step");
  allSteps.forEach(btn => {
    const s = Number(btn.dataset.step);
    if(s === prev) btn.classList.remove("playhead");
    if(s === next) btn.classList.add("playhead");
  });
}

async function start(){
  await ensureAudio();
  if(isPlaying) return;

  isPlaying = true;
  startStopEl.textContent = "STOP";

  stepIndex = 0;
  updatePlayheadUI(15, 0);

  const tick = () => {
    const baseTime = ctx.currentTime;
    const delay = (stepIndex % 2 === 1) ? swingDelaySec() : 0;
    const t = baseTime + delay;

    tracks.forEach(tr => {
      const v = pattern[tr.id][stepIndex]; // 0/1/2
      if(v){
        const vel = (v === 2) ? 1.0 : 0.72; // accent vs normal
        playSound(tr.id, t, vel);
      }
    });

    const prev = stepIndex;
    stepIndex = (stepIndex + 1) % stepsCount;
    updatePlayheadUI(prev, stepIndex);
  };

  tick();
  timerId = setInterval(tick, stepDurationSec() * 1000);
}

function stop(){
  if(!isPlaying) return;
  isPlaying = false;
  startStopEl.textContent = "START";
  if(timerId) clearInterval(timerId);
  timerId = null;

  const allSteps = stepgridEl.querySelectorAll(".step");
  allSteps.forEach(btn => btn.classList.remove("playhead"));
}

startStopEl.addEventListener("click", async () => {
  if(!isPlaying) await start();
  else stop();
});

clearEl.addEventListener("click", () => {
  tracks.forEach(t => pattern[t.id].fill(0));
  buildGrid();
});

function restartIntervalIfPlaying(){
  if(!isPlaying) return;
  clearInterval(timerId);
  timerId = setInterval(() => {
    const baseTime = ctx.currentTime;
    const delay = (stepIndex % 2 === 1) ? swingDelaySec() : 0;
    const t = baseTime + delay;

    tracks.forEach(tr => {
      const v = pattern[tr.id][stepIndex];
      if(v){
        const vel = (v === 2) ? 1.0 : 0.72;
        playSound(tr.id, t, vel);
      }
    });

    const prev = stepIndex;
    stepIndex = (stepIndex + 1) % stepsCount;
    updatePlayheadUI(prev, stepIndex);
  }, stepDurationSec() * 1000);
}

bpmEl.addEventListener("change", restartIntervalIfPlaying);
swingEl.addEventListener("change", () => { /* swing n'a pas besoin de reset interval */ });
</script>

</body>
</html>
