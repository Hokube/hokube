<script>
/**
 * SHAKE -> dégradé pastel tons froids
 * + auto-reset en fondu lent
 */

let lastTime = 0;
const shakeThreshold = 14;
let lastX = null, lastY = null, lastZ = null;

const RESET_AFTER_MS = 12000; // 12 secondes
let resetTimer = null;

/* Tons froids uniquement: 140..290 */
function coolPastelHsl(){
  const h = 140 + Math.floor(Math.random() * (290 - 140 + 1));
  const s = 45 + Math.floor(Math.random() * 15);
  const l = 78 + Math.floor(Math.random() * 8);
  return `hsl(${h} ${s}% ${l}%)`;
}

function randomCoolPastelGradient(){
  const c1 = coolPastelHsl();
  const c2 = coolPastelHsl();
  const c3 = coolPastelHsl();

  // Transition rapide pour apparition
  document.body.style.transition = "background 0.8s ease";
  document.body.style.background =
    `linear-gradient(135deg, ${c1}, ${c2}, ${c3})`;
}

function resetToNeutral(){
  // Transition lente pour retour neutre
  document.body.style.transition = "background 3s ease";
  document.body.style.background = "";
}

function scheduleReset(){
  if(resetTimer) clearTimeout(resetTimer);
  resetTimer = setTimeout(resetToNeutral, RESET_AFTER_MS);
}

function triggerGradient(){
  randomCoolPastelGradient();
  scheduleReset();
}

function handleMotion(event){
  const acc = event.accelerationIncludingGravity;
  if(!acc) return;

  if(lastX !== null){
    const dx = Math.abs(lastX - acc.x);
    const dy = Math.abs(lastY - acc.y);
    const dz = Math.abs(lastZ - acc.z);

    if(dx + dy + dz > shakeThreshold){
      const now = Date.now();
      if(now - lastTime > 900){
        triggerGradient();
        lastTime = now;
      }
    }
  }

  lastX = acc.x;
  lastY = acc.y;
  lastZ = acc.z;
}

function enableMotion(){
  if(typeof DeviceMotionEvent !== "undefined" &&
     typeof DeviceMotionEvent.requestPermission === "function"){
    DeviceMotionEvent.requestPermission()
      .then(res => {
        if(res === "granted"){
          window.addEventListener("devicemotion", handleMotion, { passive:true });
          const b = document.getElementById("motionBtn");
          if(b) b.remove();
        }
      })
      .catch(()=>{});
  } else {
    window.addEventListener("devicemotion", handleMotion, { passive:true });
}
}

/* iOS bouton permission */
if(typeof DeviceMotionEvent !== "undefined" &&
   typeof DeviceMotionEvent.requestPermission === "function"){
  const btn = document.createElement("button");
  btn.id = "motionBtn";
  btn.type = "button";
  btn.textContent = "ENABLE MOTION";
  btn.onclick = enableMotion;

  btn.style.position = "fixed";
  btn.style.right = "14px";
  btn.style.bottom = "14px";
  btn.style.zIndex = "20";
  btn.style.background = "transparent";
  btn.style.color = "var(--fg)";
  btn.style.border = "1px solid var(--hair)";
  btn.style.padding = "10px 12px";
  btn.style.fontSize = "10px";
  btn.style.letterSpacing = "2px";
  btn.style.fontFamily = '"Courier New", Courier, monospace';
  btn.style.cursor = "pointer";
  btn.style.backdropFilter = "blur(8px)";
  btn.style.backgroundColor = "var(--sheet)";

  document.body.appendChild(btn);
} else {
  window.addEventListener("devicemotion", handleMotion, { passive:true });
}
</script>
